{
  "version": 3,
  "sources": ["AbstractOverlay.ts"],
  "sourcesContent": ["/*\nCopyright 2020 Adobe. All rights reserved.\nThis file is licensed to you under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License. You may obtain a copy\nof the License at http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software distributed under\nthe License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR REPRESENTATIONS\nOF ANY KIND, either express or implied. See the License for the specific language\ngoverning permissions and limitations under the License.\n*/\nimport { SpectrumElement } from '@spectrum-web-components/base';\nimport { reparentChildren } from '@spectrum-web-components/shared/src/reparent-children.js';\n\nimport type {\n    OpenableElement,\n    OverlayOptions,\n    OverlayOptionsV1,\n    OverlayState,\n    OverlayTypes,\n    Placement,\n    TriggerInteractionsV1,\n} from './overlay-types.dev.js'\nimport type { Overlay } from './Overlay.dev.js'\nimport type { VirtualTrigger } from './VirtualTrigger.dev.js'\nimport { OverlayTimer } from './overlay-timer.dev.js'\nimport { PlacementController } from './PlacementController.dev.js'\n\nexport const overlayTimer = new OverlayTimer();\n\nexport const noop = (): void => {\n    return;\n};\n\nexport class BeforetoggleClosedEvent extends Event {\n    currentState = 'open';\n    newState = 'closed';\n    constructor() {\n        super('beforetoggle', {\n            bubbles: false,\n            composed: false,\n        });\n    }\n}\n\nexport class BeforetoggleOpenEvent extends Event {\n    currentState = 'closed';\n    newState = 'open';\n    constructor() {\n        super('beforetoggle', {\n            bubbles: false,\n            composed: false,\n        });\n    }\n}\n\n/**\n * Apply a \"transitionend\" listener to an element that may not transition but\n * guarantee the callback will be fired either way.\n *\n * @param el {HTMLElement} - Target of the \"transition\" listeners.\n * @param action {Function} - Method to trigger the \"transition\".\n * @param cb {Function} - Callback to trigger when the \"transition\" has ended.\n */\nexport const guaranteedAllTransitionend = (\n    el: HTMLElement,\n    action: () => void,\n    cb: () => void\n): void => {\n    const abortController = new AbortController();\n    const runningTransitions = new Map<string, number>();\n    const cleanup = (): void => {\n        abortController.abort();\n        cb();\n    };\n    let guarantee2: number;\n    let guarantee3: number;\n    // WebKit fires `transitionrun` a little earlier, the multiple guarantees here\n    // allow WebKit to be caught, but doesn't remove the animation listener until\n    // after it would have fired in Chromium.\n    const guarantee1 = requestAnimationFrame(() => {\n        guarantee2 = requestAnimationFrame(() => {\n            guarantee3 = requestAnimationFrame(() => {\n                cleanup();\n            });\n        });\n    });\n    const handleTransitionend = (event: TransitionEvent): void => {\n        if (event.target !== el) {\n            return;\n        }\n        runningTransitions.set(\n            event.propertyName,\n            (runningTransitions.get(event.propertyName) as number) - 1\n        );\n        if (!runningTransitions.get(event.propertyName)) {\n            runningTransitions.delete(event.propertyName);\n        }\n        if (runningTransitions.size === 0) {\n            cleanup();\n        }\n    };\n    const handleTransitionrun = (event: TransitionEvent): void => {\n        if (event.target !== el) {\n            return;\n        }\n        if (!runningTransitions.has(event.propertyName)) {\n            runningTransitions.set(event.propertyName, 0);\n        }\n        runningTransitions.set(\n            event.propertyName,\n            (runningTransitions.get(event.propertyName) as number) + 1\n        );\n        cancelAnimationFrame(guarantee1);\n        cancelAnimationFrame(guarantee2);\n        cancelAnimationFrame(guarantee3);\n    };\n    el.addEventListener('transitionrun', handleTransitionrun, {\n        signal: abortController.signal,\n    });\n    el.addEventListener('transitionend', handleTransitionend, {\n        signal: abortController.signal,\n    });\n    el.addEventListener('transitioncancel', handleTransitionend, {\n        signal: abortController.signal,\n    });\n    action();\n};\n\nexport function nextFrame(): Promise<void> {\n    return new Promise((res) => requestAnimationFrame(() => res()));\n}\n\nexport function forcePaint(): void {\n    // force the browser to paint\n    document.body.offsetHeight;\n}\n\n/**\n * Abstract Overlay base class so that property tyings and imperative API\n * interfaces can be held separate from the actual class definition.\n */\nexport class AbstractOverlay extends SpectrumElement {\n    protected async applyFocus(\n        _targetOpenState: boolean,\n        _focusEl: HTMLElement | null\n    ): Promise<void> {\n        return;\n    }\n    delayed!: boolean;\n    dialogEl!: HTMLDialogElement & {\n        showPopover(): void;\n        hidePopover(): void;\n    };\n    dispose = noop;\n    protected async ensureOnDOM(_targetOpenState: boolean): Promise<void> {\n        return;\n    }\n    elements!: OpenableElement[];\n    protected async makeTransition(\n        _targetOpenState: boolean\n    ): Promise<HTMLElement | null> {\n        return null;\n    }\n    protected async manageDelay(_targetOpenState: boolean): Promise<void> {\n        return;\n    }\n    protected async manageDialogOpen(): Promise<void> {\n        return;\n    }\n    protected async managePopoverOpen(): Promise<void> {\n        return;\n    }\n    protected managePosition(): void {\n        return;\n    }\n    protected offset: number | [number, number] = 6;\n    get open(): boolean {\n        return false;\n    }\n    set open(_open: boolean) {\n        return;\n    }\n    placement?: Placement;\n    protected placementController!: PlacementController;\n    receivesFocus!: 'true' | 'false' | 'auto';\n    get state(): OverlayState {\n        return 'closed';\n    }\n    set state(_state: OverlayState) {\n        return;\n    }\n    protected _state!: OverlayState;\n    triggerElement!: HTMLElement | VirtualTrigger | null;\n    type!: OverlayTypes;\n    willPreventClose = false;\n\n    public manuallyKeepOpen(): void {\n        return;\n    }\n\n    public static update(): void {\n        const overlayUpdateEvent = new CustomEvent('sp-update-overlays', {\n            bubbles: true,\n            composed: true,\n            cancelable: true,\n        });\n        document.dispatchEvent(overlayUpdateEvent);\n    }\n\n    /**\n     * Overloaded imperative API entry point that allows for both the pre-0.37.0\n     * argument signature as well as the post-0.37.0 signature. This allows for\n     * consumers to continue to leverage it as they had been in previous releases\n     * while also surfacing the more feature-rich API that has been made available.\n     */\n    public static async open(\n        trigger: HTMLElement,\n        interaction: TriggerInteractionsV1,\n        content: HTMLElement,\n        optionsV1: OverlayOptionsV1\n    ): Promise<() => void>;\n    public static async open(\n        content: HTMLElement,\n        options?: OverlayOptions\n    ): Promise<Overlay>;\n    public static async open(\n        triggerOrContent: HTMLElement,\n        interactionOrOptions:\n            | TriggerInteractionsV1\n            | OverlayOptions\n            | undefined,\n        content?: HTMLElement,\n        optionsV1?: OverlayOptionsV1\n    ): Promise<Overlay | (() => void)> {\n        await import('@spectrum-web-components/overlay/sp-overlay.js');\n        const v2 = arguments.length === 2;\n        const overlayContent = content || triggerOrContent;\n        // Use the `this` from the `static` method context rather than a\n        // specific imported constructor to prevent opening a circular dependency.\n        const overlay = new this() as Overlay;\n        let restored = false;\n        overlay.dispose = () => {\n            overlay.addEventListener('sp-closed', () => {\n                if (!restored) {\n                    restoreContent();\n                    restored = true;\n                }\n                requestAnimationFrame(() => {\n                    overlay.remove();\n                });\n            });\n            overlay.open = false;\n            overlay.dispose = noop;\n        };\n        /**\n         * Since content must exist in an <sp-overlay>, we need a way to get it there.\n         * The best & most-direct way is to declaratively use an <sp-overlay> element,\n         * but for imperative users, we'll reparent content into an overlay that we've created for them.\n         **/\n        const restoreContent = reparentChildren([overlayContent], overlay, {\n            position: 'beforeend',\n            prepareCallback: (el) => {\n                // Ensure that content to be overlaid is no longer targetted to a specific `slot`.\n                // This allow for it to be visible in the overlaid context.\n                const slot = el.slot;\n                el.removeAttribute('slot');\n                return () => {\n                    el.slot = slot;\n                };\n            },\n        });\n\n        const v1 = !v2 && overlayContent && optionsV1;\n        if (v1) {\n            if (window.__swc.DEBUG) {\n                window.__swc.warn(\n                    overlay,\n                    `You are interacting with an ${overlay.localName} element via a deprecated imperative API. This API will be removed in a future version of the SWC library. Consider leveraging an ${overlay.localName} directly.`,\n                    'https://opensource.adobe.com/spectrum-web-components/components/overlay/',\n                    { level: 'deprecation' }\n                );\n            }\n            const trigger = triggerOrContent;\n            const interaction = interactionOrOptions;\n            const options = optionsV1;\n            overlay.delayed =\n                options.delayed || overlayContent.hasAttribute('delayed');\n            overlay.receivesFocus = options.receivesFocus ?? 'auto';\n            overlay.triggerElement = options.virtualTrigger || trigger;\n            overlay.type =\n                interaction === 'modal'\n                    ? 'modal'\n                    : interaction === 'hover'\n                    ? 'hint'\n                    : 'auto';\n            overlay.offset = options.offset ?? 6;\n            overlay.placement = options.placement;\n            overlay.willPreventClose = !!options.notImmediatelyClosable;\n            trigger.insertAdjacentElement('afterend', overlay);\n            await overlay.updateComplete;\n            overlay.open = true;\n            return overlay.dispose;\n        }\n\n        const options = interactionOrOptions as OverlayOptions;\n        overlay.append(overlayContent);\n        overlay.delayed =\n            options.delayed || overlayContent.hasAttribute('delayed');\n        overlay.receivesFocus = options.receivesFocus ?? 'auto';\n        overlay.triggerElement = options.trigger || null;\n        overlay.type = options.type || 'modal';\n        overlay.offset = options.offset ?? 6;\n        overlay.placement = options.placement;\n        overlay.willPreventClose = !!options.notImmediatelyClosable;\n        overlay.updateComplete.then(() => {\n            // Do we want to \"open\" this path, or leave that to the consumer?\n            overlay.open = true;\n        });\n        return overlay;\n    }\n}\n"],
  "mappings": ";AAWA,SAAS,uBAAuB;AAChC,SAAS,wBAAwB;AAajC,SAAS,oBAAoB;AAGtB,aAAM,eAAe,IAAI,aAAa;AAEtC,aAAM,OAAO,MAAY;AAC5B;AACJ;AAEO,aAAM,gCAAgC,MAAM;AAAA,EAG/C,cAAc;AACV,UAAM,gBAAgB;AAAA,MAClB,SAAS;AAAA,MACT,UAAU;AAAA,IACd,CAAC;AANL,wBAAe;AACf,oBAAW;AAAA,EAMX;AACJ;AAEO,aAAM,8BAA8B,MAAM;AAAA,EAG7C,cAAc;AACV,UAAM,gBAAgB;AAAA,MAClB,SAAS;AAAA,MACT,UAAU;AAAA,IACd,CAAC;AANL,wBAAe;AACf,oBAAW;AAAA,EAMX;AACJ;AAUO,aAAM,6BAA6B,CACtC,IACA,QACA,OACO;AACP,QAAM,kBAAkB,IAAI,gBAAgB;AAC5C,QAAM,qBAAqB,oBAAI,IAAoB;AACnD,QAAM,UAAU,MAAY;AACxB,oBAAgB,MAAM;AACtB,OAAG;AAAA,EACP;AACA,MAAI;AACJ,MAAI;AAIJ,QAAM,aAAa,sBAAsB,MAAM;AAC3C,iBAAa,sBAAsB,MAAM;AACrC,mBAAa,sBAAsB,MAAM;AACrC,gBAAQ;AAAA,MACZ,CAAC;AAAA,IACL,CAAC;AAAA,EACL,CAAC;AACD,QAAM,sBAAsB,CAAC,UAAiC;AAC1D,QAAI,MAAM,WAAW,IAAI;AACrB;AAAA,IACJ;AACA,uBAAmB;AAAA,MACf,MAAM;AAAA,MACL,mBAAmB,IAAI,MAAM,YAAY,IAAe;AAAA,IAC7D;AACA,QAAI,CAAC,mBAAmB,IAAI,MAAM,YAAY,GAAG;AAC7C,yBAAmB,OAAO,MAAM,YAAY;AAAA,IAChD;AACA,QAAI,mBAAmB,SAAS,GAAG;AAC/B,cAAQ;AAAA,IACZ;AAAA,EACJ;AACA,QAAM,sBAAsB,CAAC,UAAiC;AAC1D,QAAI,MAAM,WAAW,IAAI;AACrB;AAAA,IACJ;AACA,QAAI,CAAC,mBAAmB,IAAI,MAAM,YAAY,GAAG;AAC7C,yBAAmB,IAAI,MAAM,cAAc,CAAC;AAAA,IAChD;AACA,uBAAmB;AAAA,MACf,MAAM;AAAA,MACL,mBAAmB,IAAI,MAAM,YAAY,IAAe;AAAA,IAC7D;AACA,yBAAqB,UAAU;AAC/B,yBAAqB,UAAU;AAC/B,yBAAqB,UAAU;AAAA,EACnC;AACA,KAAG,iBAAiB,iBAAiB,qBAAqB;AAAA,IACtD,QAAQ,gBAAgB;AAAA,EAC5B,CAAC;AACD,KAAG,iBAAiB,iBAAiB,qBAAqB;AAAA,IACtD,QAAQ,gBAAgB;AAAA,EAC5B,CAAC;AACD,KAAG,iBAAiB,oBAAoB,qBAAqB;AAAA,IACzD,QAAQ,gBAAgB;AAAA,EAC5B,CAAC;AACD,SAAO;AACX;AAEO,gBAAS,YAA2B;AACvC,SAAO,IAAI,QAAQ,CAAC,QAAQ,sBAAsB,MAAM,IAAI,CAAC,CAAC;AAClE;AAEO,gBAAS,aAAmB;AAE/B,WAAS,KAAK;AAClB;AAMO,aAAM,wBAAwB,gBAAgB;AAAA,EAA9C;AAAA;AAYH,mBAAU;AAsBV,SAAU,SAAoC;AAmB9C,4BAAmB;AAAA;AAAA,EApDnB,MAAgB,WACZ,kBACA,UACa;AACb;AAAA,EACJ;AAAA,EAOA,MAAgB,YAAY,kBAA0C;AAClE;AAAA,EACJ;AAAA,EAEA,MAAgB,eACZ,kBAC2B;AAC3B,WAAO;AAAA,EACX;AAAA,EACA,MAAgB,YAAY,kBAA0C;AAClE;AAAA,EACJ;AAAA,EACA,MAAgB,mBAAkC;AAC9C;AAAA,EACJ;AAAA,EACA,MAAgB,oBAAmC;AAC/C;AAAA,EACJ;AAAA,EACU,iBAAuB;AAC7B;AAAA,EACJ;AAAA,EAEA,IAAI,OAAgB;AAChB,WAAO;AAAA,EACX;AAAA,EACA,IAAI,KAAK,OAAgB;AACrB;AAAA,EACJ;AAAA,EAIA,IAAI,QAAsB;AACtB,WAAO;AAAA,EACX;AAAA,EACA,IAAI,MAAM,QAAsB;AAC5B;AAAA,EACJ;AAAA,EAMO,mBAAyB;AAC5B;AAAA,EACJ;AAAA,EAEA,OAAc,SAAe;AACzB,UAAM,qBAAqB,IAAI,YAAY,sBAAsB;AAAA,MAC7D,SAAS;AAAA,MACT,UAAU;AAAA,MACV,YAAY;AAAA,IAChB,CAAC;AACD,aAAS,cAAc,kBAAkB;AAAA,EAC7C;AAAA,EAkBA,aAAoB,KAChB,kBACA,sBAIA,SACA,WAC+B;AA1OvC;AA2OQ,UAAM,OAAO,gDAAgD;AAC7D,UAAM,KAAK,UAAU,WAAW;AAChC,UAAM,iBAAiB,WAAW;AAGlC,UAAM,UAAU,IAAI,KAAK;AACzB,QAAI,WAAW;AACf,YAAQ,UAAU,MAAM;AACpB,cAAQ,iBAAiB,aAAa,MAAM;AACxC,YAAI,CAAC,UAAU;AACX,yBAAe;AACf,qBAAW;AAAA,QACf;AACA,8BAAsB,MAAM;AACxB,kBAAQ,OAAO;AAAA,QACnB,CAAC;AAAA,MACL,CAAC;AACD,cAAQ,OAAO;AACf,cAAQ,UAAU;AAAA,IACtB;AAMA,UAAM,iBAAiB,iBAAiB,CAAC,cAAc,GAAG,SAAS;AAAA,MAC/D,UAAU;AAAA,MACV,iBAAiB,CAAC,OAAO;AAGrB,cAAM,OAAO,GAAG;AAChB,WAAG,gBAAgB,MAAM;AACzB,eAAO,MAAM;AACT,aAAG,OAAO;AAAA,QACd;AAAA,MACJ;AAAA,IACJ,CAAC;AAED,UAAM,KAAK,CAAC,MAAM,kBAAkB;AACpC,QAAI,IAAI;AACJ,UAAI,MAAoB;AACpB,eAAO,MAAM;AAAA,UACT;AAAA,UACA,+BAA+B,QAAQ,SAAS,qIAAqI,QAAQ,SAAS;AAAA,UACtM;AAAA,UACA,EAAE,OAAO,cAAc;AAAA,QAC3B;AAAA,MACJ;AACA,YAAM,UAAU;AAChB,YAAM,cAAc;AACpB,YAAMA,WAAU;AAChB,cAAQ,UACJA,SAAQ,WAAW,eAAe,aAAa,SAAS;AAC5D,cAAQ,iBAAgB,KAAAA,SAAQ,kBAAR,YAAyB;AACjD,cAAQ,iBAAiBA,SAAQ,kBAAkB;AACnD,cAAQ,OACJ,gBAAgB,UACV,UACA,gBAAgB,UAChB,SACA;AACV,cAAQ,UAAS,KAAAA,SAAQ,WAAR,YAAkB;AACnC,cAAQ,YAAYA,SAAQ;AAC5B,cAAQ,mBAAmB,CAAC,CAACA,SAAQ;AACrC,cAAQ,sBAAsB,YAAY,OAAO;AACjD,YAAM,QAAQ;AACd,cAAQ,OAAO;AACf,aAAO,QAAQ;AAAA,IACnB;AAEA,UAAM,UAAU;AAChB,YAAQ,OAAO,cAAc;AAC7B,YAAQ,UACJ,QAAQ,WAAW,eAAe,aAAa,SAAS;AAC5D,YAAQ,iBAAgB,aAAQ,kBAAR,YAAyB;AACjD,YAAQ,iBAAiB,QAAQ,WAAW;AAC5C,YAAQ,OAAO,QAAQ,QAAQ;AAC/B,YAAQ,UAAS,aAAQ,WAAR,YAAkB;AACnC,YAAQ,YAAY,QAAQ;AAC5B,YAAQ,mBAAmB,CAAC,CAAC,QAAQ;AACrC,YAAQ,eAAe,KAAK,MAAM;AAE9B,cAAQ,OAAO;AAAA,IACnB,CAAC;AACD,WAAO;AAAA,EACX;AACJ;",
  "names": ["options"]
}
